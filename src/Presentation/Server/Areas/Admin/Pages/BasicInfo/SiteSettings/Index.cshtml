@page
@model UniBazzar.Server.Areas.Admin.Pages.BasicInfo.SiteSettings.IndexModel
@{
    ViewData["Title"] = "تنظیمات سایت";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">@ViewData["Title"]</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                            <i class="fas fa-plus"></i> افزودن تنظیمات جدید
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="siteSettingsTable">
                            <thead>
                                <tr>
                                    <th>نام سایت</th>
                                    <th>توضیحات</th>
                                    <th>شماره تماس</th>
                                    <th>آدرس</th>
                                    <th>لوگو</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.SiteSettings != null && Model.SiteSettings.Any())
                                {
                                    @foreach (var siteSetting in Model.SiteSettings)
                                    {
                                        <tr>
                                            <td>@siteSetting.Name</td>
                                            <td>@(siteSetting.Description?.Length > 50 ? siteSetting.Description.Substring(0, 50) + "..." : siteSetting.Description)</td>
                                            <td>@siteSetting.PhoneNumber</td>
                                            <td>@(siteSetting.Address?.Length > 30 ? siteSetting.Address.Substring(0, 30) + "..." : siteSetting.Address)</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(siteSetting.LogoURL))
                                                {
                                                    <img src="@siteSetting.LogoURL" alt="لوگو" style="max-width: 50px; max-height: 50px;" />
                                                }
                                                else
                                                {
                                                    <span class="text-muted">بدون لوگو</span>
                                                }
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-info" onclick="viewSiteSetting('@siteSetting.Id')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-warning" onclick="editSiteSetting('@siteSetting.Id')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteSiteSetting('@siteSetting.Id')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center">هیچ تنظیماتی یافت نشد</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">افزودن تنظیمات جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">نام سایت *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">شماره تماس *</label>
                                <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">توضیحات</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">آدرس</label>
                        <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="logoURL" class="form-label">آدرس لوگو</label>
                        <input type="url" class="form-control" id="logoURL" name="logoURL">
                    </div>
                    <div class="mb-3">
                        <label for="priceListID" class="form-label">لیست قیمت</label>
                        <select class="form-control" id="priceListID" name="priceListID">
                            <option value="">انتخاب کنید</option>
                            @if (Model.PriceLists != null)
                            {
                                @foreach (var priceList in Model.PriceLists)
                                {
                                    <option value="@priceList.Id">@priceList.Title</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-primary">ذخیره</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">ویرایش تنظیمات</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editForm">
                <div class="modal-body">
                    <input type="hidden" id="editId" name="id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editName" class="form-label">نام سایت *</label>
                                <input type="text" class="form-control" id="editName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPhoneNumber" class="form-label">شماره تماس *</label>
                                <input type="text" class="form-control" id="editPhoneNumber" name="phoneNumber" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">توضیحات</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAddress" class="form-label">آدرس</label>
                        <textarea class="form-control" id="editAddress" name="address" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editLogoURL" class="form-label">آدرس لوگو</label>
                        <input type="url" class="form-control" id="editLogoURL" name="logoURL">
                    </div>
                    <div class="mb-3">
                        <label for="editPriceListID" class="form-label">لیست قیمت</label>
                        <select class="form-control" id="editPriceListID" name="priceListID">
                            <option value="">انتخاب کنید</option>
                            @if (Model.PriceLists != null)
                            {
                                @foreach (var priceList in Model.PriceLists)
                                {
                                    <option value="@priceList.Id">@priceList.Title</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalLabel">مشاهده تنظیمات</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>نام سایت:</strong> <span id="viewName"></span></p>
                        <p><strong>شماره تماس:</strong> <span id="viewPhoneNumber"></span></p>
                        <p><strong>توضیحات:</strong> <span id="viewDescription"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>آدرس:</strong> <span id="viewAddress"></span></p>
                        <p><strong>لوگو:</strong> <span id="viewLogo"></span></p>
                        <p><strong>لیست قیمت:</strong> <span id="viewPriceList"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Create form submission
        $('#createForm').on('submit', function (e) {
            e.preventDefault();
            
            const formData = {
                name: $('#name').val(),
                phoneNumber: $('#phoneNumber').val(),
                description: $('#description').val(),
                address: $('#address').val(),
                logoURL: $('#logoURL').val(),
                priceListID: $('#priceListID').val() || null
            };

            $.ajax({
                url: '/api/v1/SiteSettings',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    $('#createModal').modal('hide');
                    location.reload();
                },
                error: function (xhr) {
                    alert('خطا در ایجاد تنظیمات: ' + xhr.responseJSON?.error || 'خطای نامشخص');
                }
            });
        });

        // Edit form submission
        $('#editForm').on('submit', function (e) {
            e.preventDefault();
            
            const id = $('#editId').val();
            const formData = {
                id: id,
                name: $('#editName').val(),
                phoneNumber: $('#editPhoneNumber').val(),
                description: $('#editDescription').val(),
                address: $('#editAddress').val(),
                logoURL: $('#editLogoURL').val(),
                priceListID: $('#editPriceListID').val() || null
            };

            $.ajax({
                url: `/api/v1/SiteSettings/${id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    $('#editModal').modal('hide');
                    location.reload();
                },
                error: function (xhr) {
                    alert('خطا در ویرایش تنظیمات: ' + xhr.responseJSON?.error || 'خطای نامشخص');
                }
            });
        });

        // View site setting
        function viewSiteSetting(id) {
            $.get(`/api/v1/SiteSettings/${id}`, function (data) {
                $('#viewName').text(data.name);
                $('#viewPhoneNumber').text(data.phoneNumber);
                $('#viewDescription').text(data.description || 'بدون توضیحات');
                $('#viewAddress').text(data.address || 'بدون آدرس');
                $('#viewLogo').text(data.logoURL || 'بدون لوگو');
                $('#viewPriceList').text(data.priceListID ? 'دارد' : 'ندارد');
                $('#viewModal').modal('show');
            });
        }

        // Edit site setting
        function editSiteSetting(id) {
            $.get(`/api/v1/SiteSettings/${id}`, function (data) {
                $('#editId').val(data.id);
                $('#editName').val(data.name);
                $('#editPhoneNumber').val(data.phoneNumber);
                $('#editDescription').val(data.description);
                $('#editAddress').val(data.address);
                $('#editLogoURL').val(data.logoURL);
                $('#editPriceListID').val(data.priceListID);
                $('#editModal').modal('show');
            });
        }

        // Delete site setting
        function deleteSiteSetting(id) {
            if (confirm('آیا از حذف این تنظیمات اطمینان دارید؟')) {
                $.ajax({
                    url: `/api/v1/SiteSettings/${id}`,
                    type: 'DELETE',
                    success: function () {
                        location.reload();
                    },
                    error: function (xhr) {
                        alert('خطا در حذف تنظیمات: ' + xhr.responseJSON?.error || 'خطای نامشخص');
                    }
                });
            }
        }

        // Initialize DataTable
        $(document).ready(function () {
            $('#siteSettingsTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Persian.json"
                }
            });
        });
    </script>
}
